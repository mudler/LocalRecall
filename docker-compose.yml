services:
  localai:
    image: quay.io/go-skynet/local-ai:latest
    ports:
      - 8081:8080
    environment:
      - MODELS_PATH=/models
      - BACKENDS_PATH=/backends
    volumes:
      - ./volumes/models:/models:cached
      - ./volumes/backends:/backends:cached
      - ./volumes/images/:/tmp/generated/images/
    command:
      - granite-embedding-107m-multilingual
  postgres:
    image: timescale/timescaledb:latest-pg16
    ports:
      - 5432:5432
    environment:
      - POSTGRES_DB=localrecall
      - POSTGRES_USER=localrecall
      - POSTGRES_PASSWORD=localrecall
    volumes:
      - ./volumes/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U localrecall"]
      interval: 10s
      timeout: 5s
      retries: 5
  ragserver:
    image: quay.io/mudler/localrecall
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - 8080:8080
    #env_file: ".env"
    environment:
      - COLLECTION_DB_PATH=/db
      - EMBEDDING_MODEL=granite-embedding-107m-multilingual
      - FILE_ASSETS=/assets
      - OPENAI_API_KEY=sk-1234567890
      - OPENAI_BASE_URL=http://localai:8080
      - DATABASE_URL=postgresql://localrecall:localrecall@postgres:5432/localrecall?sslmode=disable
      - VECTOR_ENGINE=postgres
      - HYBRID_SEARCH_BM25_WEIGHT=0.5
      - HYBRID_SEARCH_VECTOR_WEIGHT=0.5
    volumes:
      - ./volumes/db:/db
      - ./volumes/assets/:/assets
    depends_on:
      postgres:
        condition: service_healthy